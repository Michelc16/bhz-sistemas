<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <menuitem id="menu_guiabh_root" name="GuiaBH" sequence="10"/>

    <menuitem id="menu_guiabh_cineart_root" name="Cineart" parent="menu_guiabh_root" sequence="20"/>
    <menuitem id="menu_guiabh_cineart_movies" name="Filmes (Sync)" parent="menu_guiabh_cineart_root"
              action="action_guiabh_cineart_movie" sequence="10"/>

    <record id="action_guiabh_cineart_sync_manual" model="ir.actions.server">
        <field name="name">Sincronizar filmes (Cineart)</field>
        <field name="model_id" ref="model_guiabh_cineart_movie"/>
        <field name="binding_model_id" ref="model_guiabh_cineart_movie"/>
        <field name="binding_type">action</field>
        <field name="binding_view_types">list,form</field>
        <field name="state">code</field>
        <field name="code"><![CDATA[
results = env['guiabh.cineart.movie'].cron_sync_all()
messages = []
for entry in results:
    if entry.get('valid'):
        messages.append("%s: %s itens (%s novos, %s atualizados, %s inativos)" % (
            entry.get('cat'),
            entry.get('count'),
            entry.get('created'),
            entry.get('updated'),
            entry.get('inactive'),
        ))
    else:
        messages.append("%s: sem mudanças (falha ou poucos itens)" % entry.get('cat'))
action = {
    "type": "ir.actions.client",
    "tag": "display_notification",
    "params": {
        "title": "Sincronização executada",
        "message": "\n".join(messages) if messages else "Sincronização executada. Verifique Cineart > Filmes.",
        "type": "success",
        "sticky": False,
    },
}
        ]]></field>
    </record>

    <menuitem id="menu_guiabh_cineart_sync"
              name="Sincronizar filmes"
              parent="menu_guiabh_cineart_root"
              action="action_guiabh_cineart_sync_manual"
              sequence="20"/>
</odoo>
